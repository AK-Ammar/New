Sub ReconcileAndMatch()
    On Error GoTo ErrorHandler
    
    Dim rngE As Range, rngF As Range
    Dim cellE As Range, cellF As Range
    Dim combination As String
    Dim foundMatch As Boolean
    Dim colorIndex As Long
    Dim threshold As Double
    Dim selectedCount As Integer
    
    ' Set the ranges for columns E and F
    Set rngE = Range("E9:E15")
    Set rngF = Range("F9:F15")
    
    ' Set the initial color index
    colorIndex = 3 ' Start with color yellow (color index 3)
    
    ' Get the threshold value from cell B3
    threshold = Range("B3").Value
    
    ' Loop through each combination size
    For selectedCount = 2 To rngF.Rows.Count
        ' Loop through each cell in column E
        For Each cellE In rngE
            ' Skip empty cells in column E
            If cellE.Value <> "" Then
                ' Recursively check combinations in column F
                foundMatch = CheckCombinations(cellE.Value, rngF, selectedCount, threshold, colorIndex)
            End If
            
            ' Increment the color index for the next combination
            If foundMatch Then colorIndex = colorIndex + 1
        Next cellE
    Next selectedCount
    
    ' Exit the sub if there are no errors
    Exit Sub
    
ErrorHandler:
    ' Error handling code
    Debug.Print "An error occurred: " & Err.Description
    Resume Next
End Sub

Function CheckCombinations(amount As Variant, rng As Range, selectedCount As Integer, threshold As Double, ByRef colorIndex As Long) As Boolean
    Dim indices() As Integer
    Dim i As Integer, j As Integer
    Dim sum As Double
    Dim foundMatch As Boolean
    
    ReDim indices(1 To selectedCount)
    
    ' Initialize indices
    For i = 1 To selectedCount
        indices(i) = i
    Next i
    
    ' Loop through each combination
    Do While indices(1) <= rng.Rows.Count - selectedCount + 1
        sum = 0
        
        ' Calculate the sum of the combination
        For i = 1 To selectedCount
            sum = sum + rng.Cells(indices(i)).Value
        Next i
        
        ' Check if the sum is within the threshold
        If Abs(amount - sum) <= threshold Then
            foundMatch = True
            
            ' Highlight the matching combinations with a unique color
            For i = 1 To selectedCount
                rng.Cells(indices(i)).Offset(0, -1).Interior.ColorIndex = colorIndex
                rng.Cells(indices(i)).Interior.ColorIndex = colorIndex
            Next i
        End If
        
        ' Generate the next combination
        j = selectedCount
        Do While j >= 1 And indices(j) >= rng.Rows.Count - selectedCount + j
            j = j - 1
        Loop
        
        If j = 0 Then Exit Do
        
        indices(j) = indices(j) + 1
        
        For i = j + 1 To selectedCount
            indices(i) = indices(i - 1) + 1
        Next i
    Loop
    
    ' Return whether a match was found
    CheckCombinations = foundMatch
End Function
