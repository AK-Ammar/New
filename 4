Option Explicit

Sub ReconcileAndMatch()
    On Error GoTo ErrorHandler
    
    Dim rngE As Range, rngF As Range
    Dim cellE As Range, cellF As Range, cellG As Range
    Dim combination As String
    Dim foundMatch As Boolean
    Dim colorIndex As Long
    Dim threshold As Double
    Dim selectedCount As Integer
    
    ' Set the ranges for columns E and F
    Set rngE = Range("E9:E15")
    Set rngF = Range("F9:F15")
    
    ' Set the initial color index
    colorIndex = 3 ' Start with color yellow (color index 3)
    
    ' Get the threshold value from cell B3
    threshold = Range("B3").Value
    
    ' Loop through each combination size
    For selectedCount = 2 To rngF.Rows.Count
        ' Loop through each cell in column E
        For Each cellE In rngE
            ' Skip empty cells in column E
            If cellE.Value <> "" Then
                ' Loop through each combination of cells in column F
                For Each cellF In rngF
                    ' Skip empty cells in column F
                    If cellF.Value <> "" Then
                        ' Check if the combination is equal
                        If selectedCount = 2 Then
                            ' Check if the combination is within the threshold
                            If Abs(cellE.Value - cellF.Value) <= threshold Then
                                foundMatch = True
                                ' Highlight the matching combination with a unique color
                                cellE.Interior.ColorIndex = colorIndex
                                cellF.Interior.ColorIndex = colorIndex
                            End If
                        Else
                            ' Loop through each cell in column F again
                            For Each cellG In rngF
                                ' Skip empty cells in column F
                                If cellG.Value <> "" Then
                                    ' Calculate the combination
                                    combination = cellE.Value + cellF.Value + cellG.Value
                                    ' Check if the combination is within the threshold
                                    If Abs(combination - threshold) <= threshold Then
                                        foundMatch = True
                                        ' Highlight the matching combination with a unique color
                                        cellE.Interior.ColorIndex = colorIndex
                                        cellF.Interior.ColorIndex = colorIndex
                                        cellG.Interior.ColorIndex = colorIndex
                                    End If
                                End If
                            Next cellG
                        End If
                    End If
                Next cellF
                
                ' Increment the color index for the next combination
                If foundMatch Then colorIndex = colorIndex + 1
                foundMatch = False
            End If
        Next cellE
    Next selectedCount
    
    ' Exit the sub if there are no errors
    Exit Sub
    
ErrorHandler:
    ' Error handling code
    Debug.Print "An error occurred: " & Err.Description
    Resume Next
End Sub
