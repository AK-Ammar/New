Sub ReconcileAndMatch()
    On Error GoTo ErrorHandler
    
    Dim rngE As Range, rngF As Range
    Dim cellE As Range, cellF As Range
    Dim combination As String
    Dim foundMatch As Boolean
    Dim colorIndex As Long
    Dim threshold As Double
    
    ' Set the ranges for columns E and F
    Set rngE = Range("E9:E15")
    Set rngF = Range("F9:F15")
    
    ' Set the initial color index
    colorIndex = 3 ' Start with color yellow (color index 3)
    
    ' Get the threshold value from cell B3
    threshold = Range("B3").Value
    
    ' Loop through each combination of cells in columns E and F
    For Each cellE In rngE
        For Each cellF In rngF
            ' Skip empty cells
            If cellE.Value <> "" And cellF.Value <> "" Then
                combination = cellE.Value & " - " & cellF.Value
                
                ' Check if the combination is a match
                If IsCombinationMatch(cellE.Value, cellF, rngF, threshold) Then
                    foundMatch = True
                    
                    ' Highlight the matching combinations with a unique color
                    cellE.Interior.ColorIndex = colorIndex
                    cellF.Interior.ColorIndex = colorIndex
                    
                    ' Increment the color index for the next combination
                    colorIndex = colorIndex + 1
                End If
            End If
        Next cellF
        
        ' Reset the flag for the next iteration
        foundMatch = False
    Next cellE
    
    ' Exit the sub if there are no errors
    Exit Sub
    
ErrorHandler:
    ' Error handling code
    Debug.Print "An error occurred: " & Err.Description
    Resume Next
End Sub

Function IsCombinationMatch(amount As Variant, targetCell As Range, targetRange As Range, threshold As Double, Optional selectedCount As Integer = 1) As Boolean
    Dim cell As Range
    Dim remainingCount As Integer
    Dim remainingRange As Range
    Dim remainingAmount As Double
    
    remainingCount = selectedCount - 1
    
    ' Base case: selectedCount is 1, check if the remaining amount is within the threshold
    If remainingCount = 0 Then
        remainingAmount = amount - targetCell.Value
        If remainingAmount >= -threshold And remainingAmount <= threshold Then
            IsCombinationMatch = True
        End If
        Exit Function
    End If
    
    ' Recursive case: selectedCount is greater than 1
    Set remainingRange = Range(targetCell.Offset(1), targetRange.Cells(targetRange.Cells.Count))
    
    For Each cell In remainingRange
        If cell.Value <> "" Then
            If IsCombinationMatch(amount - targetCell.Value, cell, remainingRange, threshold, remainingCount) Then
                IsCombinationMatch = True
                Exit Function
            End If
        End If
    Next cell
    
    IsCombinationMatch = False
End Function
